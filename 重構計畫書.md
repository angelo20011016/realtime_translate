# 重構計畫書

**專案名稱：** Realtime Translate Application

**目標：**
對現有程式碼庫 (`app.py`) 進行重構和模組化，以提高可維護性、可讀性和可擴展性，同時嚴格保留所有現有功能和運行邏輯。

**現狀分析 (`app.py`)：**
目前的 `app.py` 檔案作為一個單一的入口點，處理了以下多個職責：
*   應用程式配置（Flask、OAuth、Gemini、Azure Speech SDK）。
*   Flask 路由和模板渲染。
*   SocketIO 事件處理，用於即時翻譯（單人模式和聊天模式）。
*   語音轉文字 (STT) 和文字轉語音 (TTS) 處理。
*   透過 Gemini API 進行翻譯邏輯。
*   使用者會話管理。
*   聊天室和客戶端狀態管理。
*   資源清理例程。

這種集中式的方法導致了高耦合度，使得引入新功能或調試現有功能變得困難。

**建議的模組化策略：**

核心思想是將不同的職責分離到獨立的 Python 模組中，每個模組負責一組特定的功能。這將創建一個更有組織和易於管理的專案結構。

**新的目錄結構 (在 `d:\projects\realtime_translate\src` 內)：**

```
d:\projects\realtime_translate\
├───src\
│   ├───__init__.py
│   ├───config.py
│   ├───auth.py
│   ├───routes.py
│   ├───speech_service.py
│   ├───translation_service.py
│   ├───socket_handlers.py
│   ├───client_manager.py
│   └───main.py  (這將是新的入口點，取代 app.py 的大部分內容)
└───app.py (這將成為一個輕量級的包裝器，導入並運行 main.py)
```

**模組職責：**

1.  **`src/config.py`**: 
    *   **目的：** 集中所有應用程式配置和外部服務初始化。
    *   **內容：**
        *   載入環境變數 (`dotenv`)。
        *   Flask 應用程式初始化 (`app = Flask(__name__)`)。
        *   `SECRET_KEY` 配置。
        *   SocketIO 訊息佇列的 Redis URL 設定。
        *   OAuth 配置 (`authlib.integrations.flask_client.OAuth`)。
        *   Gemini API 配置 (`google.generativeai`)。
        *   Azure Speech SDK 配置 (`azure.cognitiveservices.speech`)。
        *   `LANGUAGE_VOICES` 和 `LANGUAGE_NAMES` 字典。
        *   日誌設定。
    *   **依賴：** `os`, `json`, `logging`, `dotenv`, `flask`, `authlib`, `google.generativeai`, `azure.cognitiveservices.speech`。

2.  **`src/auth.py`**: 
    *   **目的：** 處理所有與身份驗證相關的邏輯，包括 OAuth 路由和會話管理。
    *   **內容：**
        *   Google 的 OAuth 註冊。
        *   Flask 路由：`/login`、`/authorize`、`/logout`。
        *   與 `session` 物件互動以獲取使用者資訊。
    *   **依賴：** `flask`, `authlib`, `os`。（將從 `main.py` 或 `config.py` 接收 `app` 和 `oauth` 物件）。

3.  **`src/routes.py`**: 
    *   **目的：** 定義所有標準的 Flask HTTP 路由並渲染相應的 HTML 模板。
    *   **內容：**
        *   Flask 路由：`/`、`/login_page`、`/solo`、`/system`、`/chat`。
        *   渲染模板 (`render_template`)。
        *   重定向邏輯 (`redirect`, `url_for`)。
        *   用於驗證訪問的會話檢查。
    *   **依賴：** `flask`, `session`, `redirect`, `url_for`。（將接收 `app` 物件）。

4.  **`src/speech_service.py`**: 
    *   **目的：** 封裝所有與 Azure Speech SDK 的互動，用於語音轉文字 (STT) 和文字轉語音 (TTS)。
    *   **內容：**
        *   `synthesize_speech(text, lang_code, sid, event_name)` 函數。
        *   用於創建和配置 `speechsdk.SpeechConfig`、`speechsdk.audio.PushAudioInputStream`、`speechsdk.SpeechRecognizer` 的函數。
        *   用於連接辨識器事件的輔助函數。
    *   **依賴：** `azure.cognitiveservices.speech`, `logging`, `socketio`。（將接收 `speech_config` 和 `socketio` 物件）。

5.  **`src/translation_service.py`**: 
    *   **目的：** 管理所有與 Gemini API 的互動，用於文本翻譯和內容生成。
    *   **內容：**
        *   `get_translation_prompt(text, target_lang_code)` 函數。
        *   `get_batch_prompt(transcript, mode, source_language)` 函數。
        *   調用 `model.generate_content()` 的函數。
    *   **依賴：** `google.generativeai`, `logging`。（將接收 `model` 物件）。

6.  **`src/client_manager.py`**: 
    *   **目的：** 集中管理客戶端狀態、聊天室和相關資源（辨識器、串流）。
    *   **內容：**
        *   全域字典：`clients`、`rooms`、`sid_to_room`。
        *   `cleanup_client(sid)`：停止單人客戶端辨識器並關閉串流。
        *   `cleanup_chat_client_recognizer(sid, room_id)`：停止聊天客戶端辨識器並關閉串流。
        *   將客戶端添加到/從 `clients` 和 `rooms` 中移除的邏輯。
    *   **依賴：** `logging`, `azure.cognitiveservices.speech`。（將由 `socket_handlers` 使用）。

7.  **`src/socket_handlers.py`**: 
    *   **目的：** 包含所有 SocketIO 事件處理器，協調 `speech_service`、`translation_service` 和 `client_manager` 之間的互動。
    *   **內容：**
        *   `@socketio.on('connect')`, `@socketio.on('disconnect')`。
        *   `@socketio.on('join_room')`, `@socketio.on('update_user_settings')`, `@socketio.on('start_chat_translation')`。
        *   `handle_chat_final_recognition`。
        *   `@socketio.on('start_translation')`, `@socketio.on('settings_changed')`。
        *   `handle_final_recognition`。
        *   `@socketio.on('audio_data')`。
        *   `@socketio.on('process_batch')`, `@socketio.on('request_report_audio')`。
        *   `@socketio.on('stop_translation')`。
        *   `@socketio.on('get_ai_suggestion')`。
    *   **依賴：** `socketio`, `request`, `logging`, `speech_service`, `translation_service`, `client_manager`。（將接收 `socketio`、`app`、`model`、`speech_config` 和其他必要的物件）。

8.  **`src/main.py`**: 
    *   **目的：** 主要應用程式邏輯，負責初始化 Flask 應用程式、SocketIO，並註冊來自其他模組的所有路由和 socket 處理器。
    *   **內容：**
        *   導入 `config`、`auth`、`routes`、`speech_service`、`translation_service`、`client_manager`、`socket_handlers`。
        *   初始化 `app`、`socketio`、`oauth`、`model`、`speech_config`。
        *   註冊來自 `auth.py` 和 `routes.py` 的藍圖/路由。
        *   註冊來自 `socket_handlers.py` 的 SocketIO 事件處理器。
        *   用於運行伺服器的 `if __name__ == '__main__':` 區塊。
    *   **依賴：** 所有其他 `src` 模組。

9.  **`app.py` (根目錄)**: 
    *   **目的：** 一個最小的入口點，用於運行應用程式，主要用於與現有部署設定的兼容性。
    *   **內容：**
        *   `from src.main import app, socketio`
        *   `if __name__ == '__main__':` 區塊，用於運行 `socketio.run(app, ...)`
    *   **依賴：** `src/main.py`。

**實施步驟 (高層次)：**

1.  創建 `src` 目錄和 `__init__.py`。
2.  創建 `src/config.py`，並將 `app.py` 中的所有配置和初始化程式碼移入其中。導出必要的物件 (`app`、`socketio`、`oauth`、`model`、`speech_config`、`LANGUAGE_VOICES`、`LANGUAGE_NAMES`)。
3.  創建 `src/auth.py`，並移動 OAuth 路由和相關邏輯。
4.  創建 `src/routes.py`，並移動所有標準 Flask 路由。
5.  創建 `src/speech_service.py`，並移動 `synthesize_speech` 和相關的 Azure SDK 設定。
6.  創建 `src/translation_service.py`，並移動 `get_translation_prompt`、`get_batch_prompt` 和 Gemini API 調用。
7.  創建 `src/client_manager.py`，並移動 `clients`、`rooms`、`sid_to_room` 和清理函數。
8.  創建 `src/socket_handlers.py`，並移動所有帶有 `@socketio.on` 裝飾器的函數及其輔助函數 (`handle_final_recognition`、`handle_chat_final_recognition`)。
9.  創建 `src/main.py`，用於協調所有其他 `src` 模組的導入和設定。
10. 修改原始的 `app.py`，使其成為一個導入並運行 `src.main` 的輕量級包裝器。
11. **全面測試：** 在每個重要步驟之後，驗證應用程式的功能是否與之前完全相同。這包括：
    *   登入/登出功能。
    *   單人翻譯模式（STT、TTS、Gemini 翻譯）。
    *   聊天翻譯模式（加入房間、即時翻譯、為接收者提供 TTS）。
    *   批次處理（摘要、面試教練）。
    *   錯誤處理。
