# 0912 開發計畫：資料庫與使用者紀錄功能實作

## 核心目標

將應用程式從依賴「暫時性 Session」升級為使用「永久性資料庫」來管理使用者資料，並建立一個可擴充的框架來記錄使用者活動，為未來的個人化功能和數據分析打下穩固的基礎。

---

### 第一階段：建立使用者資料庫 (打好地基)

**目標：** 建立一個 `User` 模型，並將使用者登入邏輯與資料庫對接，實現使用者資料的永久儲存。

**任務 1.1: 安裝與設定資料庫**
- [ ] 在 `requirements.txt` 中加入 `Flask-SQLAlchemy`。
- [ ] 執行 `pip install -r requirements.txt` 安裝套件。
- [ ] 在 `app.py` 中加入 SQLAlchemy 的設定，指定使用 SQLite 資料庫。

**任務 1.2: 建立使用者 (User) 模型**
- [ ] 在 `app.py` 中，使用 `db.Model` 建立一個 `User` class。
- [ ] `User` 模型應包含以下欄位：
    - `id` (Integer, Primary Key): 我們系統內的流水號 ID。
    - `google_sub` (String, Unique, Not Null): 來自 Google 的唯一 ID，用於識別使用者。
    - `name` (String): 使用者名稱。
    - `email` (String, Unique, Not Null): 使用者 Email。
    - `picture` (String): 使用者頭像的 URL。
    - `created_at` (DateTime): 使用者首次登入的時間。

**任務 1.3: 修改登入與使用者載入邏輯**
- [ ] **修改 `/authorize` 路由：**
    - 當使用者透過 Google 登入後，用 `google_sub` 查詢資料庫。
    - **如果使用者已存在：** 更新他的 `name` 和 `picture` 欄位。
    - **如果使用者不存在：** 在 `users` 資料表中為他建立一筆新紀錄。
- [ ] **修改 Session 存儲方式：**
    - Session 中不再儲存整個 user 物件，只儲存我們資料庫中的 `user.id`。
    - `session['user_id'] = a_user_from_db.id`
- [ ] **建立全域使用者載入函式：**
    - 建立一個 `@app.before_request` 函式。
    - 在每個請求處理前，檢查 `session` 中是否有 `user_id`。
    - 如果有，就用 `user_id` 從資料庫中查詢完整的使用者物件，並存入 `g.user`，方便整個應用程式取用。

**任務 1.4: 初始化資料庫**
- [ ] 執行一個一次性的 Python 指令來建立資料庫檔案 (`.db`) 和 `users` 資料表。

---

### 第二階段：實作使用者活動紀錄 (添磚加瓦)

**目標：** 在完成使用者系統後，開始記錄關鍵的使用者行為，為未來的數據分析和個人化功能做準備。

**任務 2.1: 建立活動紀錄 (Activity) 模型**
- [ ] 在 `app.py` 中，建立一個 `Activity` class。
- [ ] `Activity` 模型應包含以下欄位：
    - `id` (Integer, Primary Key)
    - `user_id` (Integer, Foreign Key): 關聯到 `User` 表的 `id`，標示這個活動是誰做的。
    - `activity_type` (String): 紀錄活動的類型，例如 `'start_solo_mode'`, `'generate_summary'`。
    - `timestamp` (DateTime): 活動發生的時間。
    - `details` (JSON): 一個 JSON 欄位，用於儲存額外的細節，例如「使用的語言」、「對話長度」等。

**任務 2.2: 在關鍵功能中加入紀錄點**
- [ ] 在 `handle_start_translation` (Solo 模式) 的邏輯中，新增一行程式碼來建立一筆 `Activity` 紀錄。
- [ ] 在 `handle_process_batch` (系統音訊模式) 的邏輯中，根據不同的 `mode` (`summarize` 或 `interview`) 建立對應的 `Activity` 紀錄。
- [ ] 在 `handle_chat_final_recognition` (聊天模式) 的邏輯中，新增程式碼來記錄聊天訊息。

---

### 未來展望

當以上兩個階段完成後，我們就擁有了一個強大的基礎，可以輕鬆地在未來開發更多進階功能，例如：

- 使用者個人的歷史紀錄頁面。
- 根據常用功能提供個人化建議。
- 統計最受歡迎的功能。
